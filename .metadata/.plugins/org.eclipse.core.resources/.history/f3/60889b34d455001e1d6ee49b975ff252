package controller.gerente;

import javafx.fxml.FXML;
import javafx.scene.control.TableColumn;
import javafx.scene.control.TableView;
import javafx.scene.control.TextField;
import javafx.scene.image.ImageView;
import javafx.scene.input.KeyEvent;
import javafx.scene.input.MouseEvent;
import model.dao.ConexãoBD;
import model.dao.Gerente.RelatorioABCDao;

import java.util.List;
import java.sql.Connection;
import java.sql.SQLException;
import java.time.LocalDate;
import java.util.Collections; // Importe esta classe para ordenação

import controller.Ferramentas.Produto;
import javafx.collections.FXCollections;
import javafx.collections.ObservableList;

public class RelatorioABCController {

    @FXML
    private TableColumn<Produto, String> AcumuladaColumn;

    @FXML
    private ImageView BtnFiltro;

    @FXML
    private ImageView BtnImprimir;

    @FXML
    private ImageView BtnPesquisar;

    @FXML
    private TableColumn<Produto, String> CurvaColumn;

    @FXML
    private TableColumn<Produto, Double> FaturamentoColumn;

    @FXML
    private TableColumn<Produto, Double> PorcentagemColumn;

    @FXML
    private TableColumn<Produto, String> ProdutoColumn;

    @FXML
    private TextField TxtPesquisa;

    @FXML
    private TableView<Produto> tableView;
    
    private RelatorioABCDao relatorioABCDao;

 
    private ObservableList<Produto> produtosList = FXCollections.observableArrayList(); // Crie uma lista observável para armazenar seus produtos


    private void calcularPorcentagensEAdicionarCurva() {
    	
    	System.out.println("oiiii2");

       
        Collections.sort(produtosList, (produto1, produto2) -> {
            double faturamento1 = produto1.getFaturamento();
            double faturamento2 = produto2.getFaturamento();
            return Double.compare(faturamento2, faturamento1);
        });

        double totalFaturamento = 0.0;

        // Calcular o total do faturamento
        for (Produto produto : produtosList) {
            totalFaturamento += produto.getFaturamento();
        }

        double porcentagemAcumulada = 0.0;

        // Calcular porcentagens e adicionar a curva
        for (Produto produto : produtosList) {
            double faturamentoProduto = produto.getFaturamento();
            double porcentagemProduto = (faturamentoProduto / totalFaturamento) * 100;
            porcentagemAcumulada += porcentagemProduto;
            produto.setPorcentagem(porcentagemProduto);
            if (porcentagemAcumulada <= 60) {
                produto.setCurva("A");
            } else if (porcentagemAcumulada <= 90) {
                produto.setCurva("B");
            } else {
                produto.setCurva("C");
            }
        }
    }

    private void carregarDadosDoBanco() {
    	
    	System.out.println("oiiii");
    	
        try {
            Connection conexao = ConexãoBD.Conexao(); // Obtenha uma conexão com o banco de dados
            relatorioABCDao = new RelatorioABCDao(conexao); // Crie uma instância do DAO com a conexão

            // Substitua o método abaixo com o método apropriado do seu DAO para obter os produtos do banco de dados
            List<Produto> produtosDoBanco = relatorioABCDao.obterProdutosDoBanco();

            produtosList.addAll(produtosDoBanco);

            calcularPorcentagensEAdicionarCurva(); // Calcule porcentagens e adicione a curva
        } catch (SQLException e) {
            e.printStackTrace();
        }
    }


    @FXML
    private void initialize() {
    	
    	
    	 //carregarDadosDoBanco();

    	     
    	    Produto produtoManual = new Produto("Produto Manual", LocalDate.now(), 10, 15.0, 25.0, "Marca X", "123456", 5, 5, 125.0);
    	    produtosList.add(produtoManual);

    	    //calcularPorcentagensEAdicionarCurva();

    	
    	    // Agora, crie um novo objeto Produto diretamente e adicione à tabela
    	    Produto novoProduto = new Produto(
    	            "Novo Produto",
    	            LocalDate.now(),
    	            10, // Quantidade
    	            15.0, // Valor de compra por unidade
    	            25.0, // Valor de venda por unidade
    	            "Marca do Novo Produto",
    	            "Código do Novo Produto",
    	            0, // Quantidade adquirida
    	            5, // Quantidade vendida
    	            5 * 25.0 // Faturamento
    	    );

    	    // Defina uma curva para o novo produto
    	    novoProduto.setCurva("A");
    	    
    	    System.out.println("Initialize chamado");
    	    

    	    // Adicione o novo produto à tabela
    	    tableView.getItems().add(novoProduto);
    	    
    	    
    	   //tableView.setItems(produtosList);
       
        
        
    }
    
    
    
    @FXML
    void EfeitoFiltro(MouseEvent event) {

    }

    @FXML
    void EfeitoImprimir(MouseEvent event) {

    }

    @FXML
    void Filtro(MouseEvent event) {

    }

    @FXML
    void Pesquisar(MouseEvent event) {

    }

    @FXML
    void PressionarEnter(KeyEvent event) {

    }

    @FXML
    void SairFiltro(MouseEvent event) {

    }

    @FXML
    void SairImprimir(MouseEvent event) {

    }

    @FXML
    void imprimir(MouseEvent event) {

    }

    @FXML
    void vol1(MouseEvent event) {

    }

}
