package controller.gerente;

import javafx.fxml.FXML;
import javafx.scene.control.TableColumn;
import javafx.scene.control.TableView;
import javafx.scene.control.TextField;
import javafx.scene.image.ImageView;
import javafx.scene.input.KeyEvent;
import javafx.scene.input.MouseEvent;
import model.dao.ConexãoBD;
import model.dao.Gerente.RelatorioABCDao;

import java.util.List;
import java.sql.Connection;
import java.sql.SQLException;
import java.time.LocalDate;
import java.util.Collections; 

import controller.Ferramentas.Produto;
import javafx.collections.FXCollections;
import javafx.collections.ObservableList;

public class RelatorioABCController {

    @FXML
    private TableColumn<Produto, String> AcumuladaColumn;

    @FXML
    private ImageView BtnFiltro;

    @FXML
    private ImageView BtnImprimir;

    @FXML
    private ImageView BtnPesquisar;

    @FXML
    private TableColumn<Produto, String> CurvaColumn;

    @FXML
    private TableColumn<Produto, Double> FaturamentoColumn;

    @FXML
    private TableColumn<Produto, Double> PorcentagemColumn;

    @FXML
    private TableColumn<Produto, String> ProdutoColumn;

    @FXML
    private TextField TxtPesquisa;

    @FXML
    private TableView<Produto> tableView;
    
    private RelatorioABCDao relatorioABCDao;

 
    private ObservableList<Produto> produtosList = FXCollections.observableArrayList(); // Crie uma lista observável para armazenar seus produtos


    private void calcularPorcentagensEAdicionarCurva() {
    	


       
        Collections.sort(produtosList, (produto1, produto2) -> {
            double faturamento1 = produto1.getFaturamento();
            double faturamento2 = produto2.getFaturamento();
            return Double.compare(faturamento2, faturamento1);
        });

        double totalFaturamento = 0.0;

        // Calcular o total do faturamento
        for (Produto produto : produtosList) {
            totalFaturamento += produto.getFaturamento();
        }

        double porcentagemAcumulada = 0.0;

        // Calcular porcentagens e adicionar a curva
        for (Produto produto : produtosList) {
            double faturamentoProduto = produto.getFaturamento();
            double porcentagemProduto = (faturamentoProduto / totalFaturamento) * 100;
            porcentagemAcumulada += porcentagemProduto;
            produto.setPorcentagem(porcentagemProduto);
            if (porcentagemAcumulada <= 60) {
                produto.setCurva("A");
            } else if (porcentagemAcumulada <= 90) {
                produto.setCurva("B");
            } else {
                produto.setCurva("C");
            }
        }
    }

    private void carregarDadosDoBanco() {
    	
    	
    	
        try {
            Connection conexao = ConexãoBD.Conexao(); // Obtenha uma conexão com o banco de dados
            relatorioABCDao = new RelatorioABCDao(conexao); // Crie uma instância do DAO com a conexão

            // Substitua o método abaixo com o método apropriado do seu DAO para obter os produtos do banco de dados
            List<Produto> produtosDoBanco = relatorioABCDao.obterProdutosDoBanco();

            produtosList.addAll(produtosDoBanco);

            calcularPorcentagensEAdicionarCurva(); // Calcule porcentagens e adicione a curva
        } catch (SQLException e) {
            e.printStackTrace();
        }
    }


    @FXML
    private void initialize() {
        carregarDadosDoBanco();

        Produto produtoManual = new Produto("Produto Manual", LocalDate.now(), 10, 15.0, 25.0, "Marca X", "123456", 5, 5, 125.0);
        produtosList.add(produtoManual);

        calcularPorcentagensEAdicionarCurva();

      
        System.out.println(produtosList);
       
        tableView.setItems(produtosList);
        Produto novoProduto = new Produto("Produto Novo", LocalDate.of(2024, 12, 31), 50, 9.0, 18.0, "Nova Marca", "NOV123", 0, 10, 180.0);
        novoProduto.setCurva("AA");
        tableView.getItems().add(novoProduto);
        
        
        System.out.println(novoProduto);
    }
    
    
    @FXML
    void EfeitoFiltro(MouseEvent event) {

    }

    @FXML
    void EfeitoImprimir(MouseEvent event) {

    }

    @FXML
    void Filtro(MouseEvent event) {

    }

    @FXML
    void Pesquisar(MouseEvent event) {

    }

    @FXML
    void PressionarEnter(KeyEvent event) {

    }

    @FXML
    void SairFiltro(MouseEvent event) {

    }

    @FXML
    void SairImprimir(MouseEvent event) {

    }

    @FXML
    void imprimir(MouseEvent event) {

    }

    @FXML
    void vol1(MouseEvent event) {

    }

}
